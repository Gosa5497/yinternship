{% extends 'departement_head/base.html' %}
{% block title %}Chat with {{ receiver.username }}{% endblock %}
{% block content %}

<div class="content-wrapper">
    <section class="content-header">
        <h1>Chat with {{ receiver.username }}</h1>
    </section>
    <section class="content">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="card card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Chat</h3>
                        </div>
                        <div class="card-body chat-container" id="chat-messages">
                            {% if chat_messages %}
                                {% for message in chat_messages %}
                                    <div class="message-container {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                                        <div class="chat-bubble">
                                            <p>{{ message.message }}</p>
                                            <small class="text-muted">{{ message.timestamp|time:"H:i" }}</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p>No messages available.</p>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <form id="chat-form" method="POST" action="{% url 'private_chat' receiver.id %}">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="text" id="chat-message-input" name="message" class="form-control" placeholder="Type a message..." required>
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<style>
/* Chat container styling */
.chat-container {
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 5px;
}

/* Message container styling */
.message-container {
    display: flex;
    margin-bottom: 10px;
}

/* Sent messages (right side) */
.message-container.sent {
    justify-content: flex-end;
}

/* Received messages (left side) */
.message-container.received {
    justify-content: flex-start;
}

/* Chat bubble styling */
.chat-bubble {
    max-width: 70%;
    padding: 10px;
    border-radius: 10px;
    position: relative;
}

/* Sent message bubble */
.message-container.sent .chat-bubble {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

/* Received message bubble */
.message-container.received .chat-bubble {
    background-color: #e9ecef;
    color: black;
    margin-right: auto;
}

/* Timestamp styling */
.text-muted {
    font-size: 0.8em;
    display: block;
    margin-top: 5px;
}
</style>

<script>
// WebSocket functionality (optional - remove if not needed)
const chatSocket = new WebSocket(
    (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + 
    '/ws/private_chat/{{ receiver.id }}/'
);

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatMessages = document.getElementById('chat-messages');

    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-container ' + (data.sender.trim() === '{{ request.user.username }}'.trim() ? 'sent' : 'received');
    messageDiv.innerHTML = `
        <div class="chat-bubble">
            <p>${data.message}</p>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
    `;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

document.querySelector('#chat-form').onsubmit = function(e) {
    e.preventDefault();
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value.trim();
    
    if (message) {
        // Send message via WebSocket (optional)
        chatSocket.send(JSON.stringify({
            'message': message,
            'sender': '{{ request.user.username }}',
            'csrf_token': '{{ csrf_token }}'  // Include CSRF token for security
        }));

        // Send message via HTTP POST (required for database storage)
        const form = document.querySelector('#chat-form');
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(new FormData(form))
        }).then(response => {
            if (response.ok) {
                messageInput.value = '';  // Clear input field
                location.reload();  // Refresh page to show new message
            }
        });
    }
};
</script>

{% endblock %}