{% extends 'departement_head/base.html' %}
{% block title %}Group Chat: {{ group.name }}{% endblock %}
{% block content %}
<div class="content-wrapper">
    <section class="content-header">
        <h1>Group Chat: {{ group.name }}</h1>
    </section>
    <section class="content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-body">
                            <!-- Chat Messages -->
                            <div id="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                                {% for message in messages %}
                                <div class="message-container {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                                    <div class="chat-bubble">
                                        <strong>{{ message.sender.username }}</strong>
                                        <p>{{ message.message }}</p>
                                        <small class="text-muted">{{ message.timestamp|time:"H:i" }}</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <!-- Chat Input -->
                            <form id="chat-form" class="mt-3" method="POST" action="{% url 'group_chat' group.id %}">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="text" id="chat-message-input" name="message" class="form-control" placeholder="Type your message..." required>
                                    <div class="input-group-append">
                                        <button type="submit" class="btn btn-primary">Send</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- WebSocket Script -->
<script>
const chatSocket = new WebSocket(
    'ws://' + window.location.host + '/ws/group_chat/{{ group.id }}/'
);

chatSocket.onmessage = function(e) {
    const data = JSON.parse(e.data);
    const chatMessages = document.getElementById('chat-messages');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message-container ' + (data.sender.trim() === '{{ request.user.username }}'.trim() ? 'sent' : 'received');
    messageDiv.innerHTML = `
        <div class="chat-bubble">
            <strong>${data.sender}</strong>
            <p>${data.message}</p>
            <small class="text-muted">${new Date().toLocaleTimeString()}</small>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

document.querySelector('#chat-form').onsubmit = function(e) {
    e.preventDefault();
    const messageInput = document.querySelector('#chat-message-input');
    const message = messageInput.value.trim();
    
    if (message) {
        // Send message via WebSocket (optional)
        chatSocket.send(JSON.stringify({
            'message': message,
            'sender': '{{ request.user.username }}',
            'csrf_token': '{{ csrf_token }}'  // Include CSRF token for security
        }));

        // Send message via HTTP POST (required for database storage)
        const form = document.querySelector('#chat-form');
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(new FormData(form))
        }).then(response => {
            if (response.ok) {
                messageInput.value = '';  // Clear input field
                location.reload();  // Refresh page to show new message
            }
        });
    }
};
</script>

<style>
/* Chat container styling */
#chat-messages {
    height: 400px;
    overflow-y: auto;
    padding: 10px;
    background-color: #f9f9f9;
    border-radius: 5px;
}

/* Message container styling */
.message-container {
    display: flex;
    margin-bottom: 10px;
}

/* Sent messages (right side) */
.message-container.sent {
    justify-content: flex-end;
}

/* Received messages (left side) */
.message-container.received {
    justify-content: flex-start;
}

/* Chat bubble styling */
.chat-bubble {
    max-width: 70%;
    padding: 10px;
    border-radius: 10px;
    position: relative;
}

/* Sent message bubble */
.message-container.sent .chat-bubble {
    background-color: #007bff;
    color: white;
    margin-left: auto;
}

/* Received message bubble */
.message-container.received .chat-bubble {
    background-color: #e9ecef;
    color: black;
    margin-right: auto;
}

/* Timestamp styling */
.text-muted {
    font-size: 0.8em;
    display: block;
    margin-top: 5px;
}
</style>
{% endblock %}